name: CI/CD

on: [push]

jobs:
  build:
    if: "!contains(github.event.head_commit.message, 'NO_CI')"
    strategy:
      matrix:
        platform: [x64]
        os: [ubuntu-latest, windows-latest]
    runs-on: '${{ matrix.os }}'
    name: 'Test: ${{ matrix.os }} / ${{ matrix.platform }}'
    steps:
    - name: Checkout
      uses: actions/checkout@main
      with:
        fetch-depth: 1
        submodules: recursive
        token: ${{ secrets.GH_PAT }}
    - name: Setup opencv
      uses: Dovyski/setup-opencv-action@v1
      with:
        opencv-version: '4.1.0'
    - name: Build
      run: |
        cd build/
        cmake --build
        cd ..
    - name: Check for modified files
      id: git-check
      run: echo ::set-output name=modified::$(if git diff-index --quiet HEAD -- build/*; then echo "false"; else echo "true"; fi)
    - name: Push changes
      if: steps.git-check.outputs.modified == 'true'
      run: |
        pwd
        echo $(git diff-index HEAD --)
        git config --global user.name 'Build Bot'
        git config --global user.email 'build.bot@karaka.app'
        git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}
        git add build/.
        git status
        git commit -m "Automatic build" || true
        git push || true
